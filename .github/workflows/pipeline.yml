name: CareerAgentPro CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # Frontend CI
  # ============================================
  frontend-ci:
    name: ðŸŽ¨ Frontend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: ðŸ“š Install dependencies
        run: npm ci
      
      - name: ðŸ” Lint check
        run: npm run lint
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          # Ensure build doesn't fail on warnings
          CI: true
      
      - name: ðŸ“Š Report bundle size
        run: |
          echo "## ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next" ]; then
            echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            find .next/static -name "*.js" -exec ls -lh {} \; | awk '{print "| " $NF " | " $5 " |"}' | head -10 >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Backend CI
  # ============================================
  backend-ci:
    name: ðŸ Backend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“š Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” Syntax check
        run: python -m py_compile main.py
      
      - name: ðŸ” Type checking (optional)
        continue-on-error: true
        run: |
          pip install mypy
          mypy main.py --ignore-missing-imports || true
      
      - name: ðŸ“Š Report
        run: |
          echo "## ðŸ Backend Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Python version: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dependencies installed: $(pip list --format=freeze | wc -l) packages" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deployment Readiness Check
  # ============================================
  deploy-ready:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âœ… Validate vercel.json
        run: |
          if [ ! -f vercel.json ]; then
            echo "âŒ vercel.json missing!"
            exit 1
          fi
          python3 -c "import json; json.load(open('vercel.json'))" && echo "âœ… vercel.json is valid JSON"
      
      - name: âœ… Check required files
        run: |
          echo "Checking required files..."
          files=("frontend/package.json" "frontend/next.config.ts" "backend/main.py" "backend/requirements.txt" "vercel.json")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing!"
              exit 1
            fi
          done
      
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel Config | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Ready to deploy to Vercel!" >> $GITHUB_STEP_SUMMARY
